# Drush CLI Tool Configuration
# Drupal site management via command-line

tools:
  - name: drush
    enabled: true
    description: |
      Execute Drush commands for Drupal site management.

      Best practice: Always check site status before operations.

      IMPORTANT: NEVER use --db-url parameter. Drush automatically uses the 
      database connection from Drupal's settings.php, which is already properly 
      configured via environment variables (DB_HOST, DB_NAME, DB_USER, DB_PASS).
      Adding --db-url will break this auto-configuration and cause SSL/TLS errors.

      Why --db-url fails:
      - It bypasses Drupal's configured database settings
      - PDO enforces SSL/TLS verification by default
      - DDEV's MariaDB doesn't have SSL enabled

      For database operations like site-install or sql-drop, use the specialized
      "drush_sql_drop" and "drush_site_install" tools instead.

      For running PHP code, use the "php_exec" tool instead of drush eval/php-eval
      (which have escaping and parsing issues).

    type: command
    command_template: "vendor/bin/drush {command} {args}"
    container: "ddev-{DDEV_PROJECT}-web"
    user: auto:uid-from-path

    default_args:
      args: ""

    # Blacklist: disallowed commands and patterns
    disallowed_commands:
      - sql-sync
      - site-install
      - sql-drop
      - cr
      - cache-rebuild

    # Validate arguments to prevent --db-url usage
    validate_args: true
    validation_rules:
      - pattern: "--db-url"
        message: |
          ERROR: --db-url is not permitted. Drush is already auto-configured 
          to use the database connection from Drupal's settings.php.

          Adding --db-url breaks this auto-configuration and causes SSL errors:
          - It bypasses Drupal's configured database settings
          - PDO enforces SSL/TLS verification by default
          - DDEV's MariaDB doesn't have SSL enabled

          Solution: Remove --db-url from your command
          Example: drush cr (for cache rebuild)

    input_schema:
      type: object
      properties:
        command:
          type: string
          description: Drush command to execute (e.g., "status", "en module_name", "cr")
        args:
          type: string
          description: Additional flags and arguments. DO NOT use --db-url.
      required:
        - command

  - name: drush_cr
    enabled: true
    description: |
      Clear and rebuild all Drupal caches.

      This is the dedicated command for cache rebuild (drush cr/cache-rebuild).
      Use this instead of the generic drush command for cache operations.

      This command is fast and safe to run at any time. It's commonly used:
      - After installing or enabling modules
      - After configuration changes
      - After code changes that affect cached data
      - When debugging issues that may be cache-related

    type: command
    command_template: "vendor/bin/drush cache:rebuild"
    container: "ddev-{DDEV_PROJECT}-web"
    user: auto:uid-from-path

    input_schema:
      type: object
      properties: {}

  - name: drush_sql_drop
    enabled: true
    description: |
      Safely drop the Drupal database using environment-configured connection.

      This is a safe alternative to 'drush sql-drop' that avoids --db-url issues.
      Database is configured via environment variables, not connection strings.

    type: command
    command_template: "vendor/bin/drush sql-drop -y --extra=--skip-ssl 2>&1 || true"
    container: "ddev-{DDEV_PROJECT}-web"
    user: auto:uid-from-path

    input_schema:
      type: object
      properties: {}

  - name: drush_site_install
    enabled: true
    description: |
      Safely install/reinstall Drupal using environment-configured database.

      This is a safe alternative that avoids --db-url issues. Database must be
      pre-dropped before installation (use drush_sql_drop first).

      Parameters control admin account and installation profile.

    type: command
    command_template: "vendor/bin/drush site-install {profile} -y --account-name={admin_name} --account-pass={admin_pass} --extra=--skip-ssl"
    container: "ddev-{DDEV_PROJECT}-web"
    user: auto:uid-from-path

    default_args:
      profile: "standard"
      admin_name: "admin"
      admin_pass: "admin"

    input_schema:
      type: object
      properties:
        profile:
          type: string
          description: Installation profile (default "standard", e.g. "minimal", "standard")
          default: "standard"
        admin_name:
          type: string
          description: Administrator username (default "admin")
          default: "admin"
        admin_pass:
          type: string
          description: Administrator password (default "admin")
          default: "admin"

  - name: logs_watchdog
    enabled: true
    description: |
      Read Drupal watchdog logs from the database.

      Shows application-level logs stored in Drupal's watchdog table (dblog module).
      Requires drush and dblog module to be enabled.
      Default: Last 100 entries. Maximum: 1000 entries.

    type: command
    command_template: "vendor/bin/drush watchdog:show --count={lines}"
    container: "ddev-{DDEV_PROJECT}-web"
    user: auto:uid-from-path
    default_args:
      lines: 100

    input_schema:
      type: object
      properties:
        lines:
          type: integer
          description: Number of entries to return (default 100, max 1000)

  - name: drush_php_eval
    enabled: true
    description: |
      Execute PHP code with full Drupal bootstrap context.

      Use this for:
      - Testing code snippets before implementation
      - Exploring Drupal APIs and data structures
      - Debugging application state
      - Querying entities and configuration
      - One-off data operations

      DO NOT use for:
      - Operations available via drush (use drush instead)
      - Complex multi-statement code (create a file instead)
      - Database operations (use drush sql-* or create proper migrations)

      The code runs in the context of a bootstrapped Drupal site with all APIs available.

      Examples:
      - Get node count: echo \Drupal::entityQuery('node')->count()->execute();
      - List content types: print_r(array_keys(\Drupal::entityTypeManager()->getStorage('node_type')->loadMultiple()));
      - Check module status: echo \Drupal::moduleHandler()->moduleExists('views') ? 'enabled' : 'disabled';

    type: command
    command_template: 'vendor/bin/drush php:eval "{code}"'
    container: "ddev-{DDEV_PROJECT}-web"
    user: auto:uid-from-path

    input_schema:
      type: object
      properties:
        code:
          type: string
          description: |
            PHP code to execute (without <?php tags). 
            Use single quotes in the code, as double quotes may cause issues.
            Keep it simple - one or two statements max.
            For complex code, create a .php file instead.
      required:
        - code
